<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Restoran - Bootstrap Restaurant Template</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="" name="keywords">
    <meta content="" name="description">
    <%- include('config/export') %>
        <style>
            .modal-backdrop.show {
                background-color: rgba(0, 0, 0, 0.5);
            }

            .location-alert {
                background-color: #f8d7da;
                color: #721c24;
                padding: 10px;
                border-radius: 5px;
                margin-top: 10px;
            }
        </style>
</head>

<body>
    <div class="container-xxl bg-white p-0">
        <%- include('config/nav') %>
            <div class="container-xxl py-5 bg-dark hero-header mb-5">
                <div class="container text-center my-5 pt-5 pb-4">
                    <h1 class="display-3 text-white mb-3 animated slideInDown">Fill The Request</h1>
                </div>
            </div>

            <div class="container">
                <h2 class="text-center">Food Requests</h2>
                <div class="row">
                    <% requests.forEach(request=> { %>
                        <div class="col-md-4">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">
                                        <%= request.user.name %>
                                    </h5>
                                    <p class="card-text">Food Type: <%= request.foodType %>
                                    </p>
                                    <p class="card-text">Quantity Needed: <%= request.quantity %> servings</p>
                                    <p class="card-text">Delivery Option: <%= request.deliveryOption %>
                                    </p>

                                    <button class="btn btn-primary"
                                        onclick="showDonationForm('<%= request._id %>', '<%= request.user._id %>')">I
                                        want to donate</button>

                                    <div class="modal fade" id="donationModal-<%= request._id %>" tabindex="-1"
                                        aria-labelledby="donationModalLabel" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="donationModalLabel">Donate to <%=
                                                            request.user.name %>
                                                    </h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                        aria-label="Close"></button>
                                                </div>

                                                <div class="modal-body">
                                                    <form id="donationForm-<%= request._id %>"
                                                        action="/request/i-want-to-donate" method="POST" class="mt-3">
                                                        <input type="hidden" id="latitude" name="latitude">
                                                        <input type="hidden" id="longitude" name="longitude">
                                                        <input type="hidden" name="requestId"
                                                            value="<%= request._id %>">
                                                        <input type="hidden" name="recipientId"
                                                            value="<%= request.user._id %>">

                                                        <div class="mb-2">
                                                            <textarea name="message" id="message-<%= request._id %>"
                                                                placeholder="Write Message" class="w-100"
                                                                rows="6"></textarea>
                                                            <div class="invalid-feedback"
                                                                id="messageError-<%= request._id %>"
                                                                style="display: none;">Message must be at least 5 words.
                                                            </div>
                                                        </div>

                                                        <div class="mb-3">
                                                            <label for="address" class="form-label">Proper
                                                                Address</label>
                                                            <input type="text" class="form-control"
                                                                id="address-<%= request._id %>" name="address" required>
                                                            <div class="invalid-feedback"
                                                                id="addressError-<%= request._id %>"
                                                                style="display: none;">Address must be at least 2 words.
                                                            </div>
                                                        </div>

                                                        <button type="submit" class="btn btn-success"
                                                            id="donateButton-<%= request._id %>"
                                                            disabled>Donate</button>
                                                    </form>
                                                    <button type="button" id="useMyLocation-<%= request._id %>"
                                                        class="btn btn-info mt-2">Allow Location Tracking</button>
                                                    <div class="location-alert">
                                                        We accept the live location to track your location for the
                                                        recipient to receive the food.
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <% }) %>
                </div>
            </div>

            <script>
                function showDonationForm(requestId, recipientId) {
                    const modal = new bootstrap.Modal(document.getElementById('donationModal-' + requestId));
                    modal.show();
                }

                document.addEventListener("DOMContentLoaded", function () {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.addEventListener('hidden.bs.modal', function () {
                            document.getElementById('donationForm-' + modal.id.replace('donationModal-', '')).reset();
                            document.querySelectorAll('.is-invalid').forEach(field => field.classList.remove('is-invalid'));
                            document.querySelectorAll('.invalid-feedback').forEach(error => error.style.display = 'none');
                        });
                    });
                });

                function validateField(field, condition, errorMessage, errorElement) {
                    if (condition) {
                        field.classList.add("is-invalid");
                        field.classList.remove("is-valid");
                        errorElement.style.display = 'block';
                        errorElement.textContent = errorMessage;
                    } else {
                        field.classList.remove("is-invalid");
                        field.classList.add("is-valid");
                        errorElement.style.display = 'none';
                    }
                }

                function enableSubmitButton(requestId) {
                    const message = document.getElementById("message-" + requestId);
                    const address = document.getElementById("address-" + requestId);
                    const donateButton = document.getElementById("donateButton-" + requestId);
                    const messageError = document.getElementById("messageError-" + requestId);
                    const addressError = document.getElementById("addressError-" + requestId);

                    const wordCountMessage = message.value.trim().split(/\s+/).length;
                    const wordCountAddress = address.value.trim().split(/\s+/).length;

                    validateField(message, wordCountMessage < 5, "Message must be at least 5 words.", messageError);
                    validateField(address, wordCountAddress < 2, "Address must be at least 2 words.", addressError);

                    if (document.querySelectorAll(".is-invalid").length === 0) {
                        donateButton.disabled = false;
                    } else {
                        donateButton.disabled = true;
                    }
                }

                document.querySelectorAll('textarea').forEach(message => {
                    message.addEventListener("input", () => enableSubmitButton(message.id.split('-')[1]));
                });

                document.querySelectorAll('input').forEach(address => {
                    address.addEventListener("input", () => enableSubmitButton(address.id.split('-')[1]));
                });

                document.querySelectorAll('form').forEach(form => {
                    form.addEventListener("submit", function (event) {
                        if (document.querySelectorAll(".is-invalid").length > 0) {
                            event.preventDefault();
                        } else {
                            const modal = bootstrap.Modal.getInstance(form.closest('.modal'));
                            modal.hide();
                        }
                    });
                });

                document.querySelectorAll('.btn-info').forEach((btn, index) => {
                    btn.addEventListener("click", function () {
                        const requestId = index;
                        if (navigator.geolocation) {
                            navigator.geolocation.getCurrentPosition(
                                (position) => {
                                    document.getElementById("latitude").value = position.coords.latitude;
                                    document.getElementById("longitude").value = position.coords.longitude;
                                },
                                () => alert("Failed to get location. Please enable GPS.")
                            );
                        } else {
                            alert("Geolocation is not supported by your browser.");
                        }
                    });
                });
            </script>

            <%- include('config/footer') %>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>